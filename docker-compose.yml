# AKLight v2 - Docker Compose
# Uso:
#   docker-compose up --build              # Iniciar todo
#   docker-compose logs -f                 # Ver todos los logs
#   docker-compose logs -f consumer1       # Ver logs del consumer
#   docker-compose logs -f producer1       # Ver logs del producer
#   docker-compose down -v                 # Detener y limpiar

services:
  # BROKER 1
  broker1:
    build:
      context: .
      dockerfile: broker/Dockerfile
    container_name: aklight_broker1
    hostname: broker1
    environment:
      - BROKER_ID=1
    ports:
      - "7000:7000"
    volumes:
      - broker1_data:/app/data
    networks:
      - aklight_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "7000"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 3s

  # BROKER 2
  broker2:
    build:
      context: .
      dockerfile: broker/Dockerfile
    container_name: aklight_broker2
    hostname: broker2
    environment:
      - BROKER_ID=2
    ports:
      - "7001:7001"
    volumes:
      - broker2_data:/app/data
    networks:
      - aklight_net
    restart: unless-stopped
    depends_on:
      broker1:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "7001"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 3s

  # PRODUCER 1
  producer1:
    build:
      context: .
      dockerfile: producer/Dockerfile
    container_name: aklight_producer1
    hostname: producer1
    environment:
      - PRODUCER_ID=producer1
      - BASE_TOPIC=metrics/docker
      - BROKER_HOST=broker1
      - BROKER_PORT=7000
      - INTERVAL=5
      - USE_KEY=1
    networks:
      - aklight_net
    depends_on:
      broker1:
        condition: service_healthy
    restart: unless-stopped

  # PRODUCER 2 
  producer2:
    build:
      context: .
      dockerfile: producer/Dockerfile
    container_name: aklight_producer2
    hostname: producer2
    environment:
      - PRODUCER_ID=producer2
      - BASE_TOPIC=metrics/docker
      - BROKER_HOST=broker2
      - BROKER_PORT=7001
      - INTERVAL=5
      - USE_KEY=1
    networks:
      - aklight_net
    depends_on:
      broker2:
        condition: service_healthy
    restart: unless-stopped

  # CONSUMER 1 -> conecta a BROKER 1, recibe de ambos producers via wildcard
  consumer1:
    build:
      context: .
      dockerfile: consumer/Dockerfile
    container_name: aklight_consumer1
    hostname: consumer1
    environment:
      - CONSUMER_ID=consumer1
      - SESSION_PERSISTENT=1
      - BROKER_HOST=broker1
      - BROKER_PORT=7000
      - TOPICS=metrics/docker/#
      - CPU_THRESHOLD=0.70
      - MEM_THRESHOLD=10
      - ALERT_COOLDOWN=300
      - TWILIO_ACCOUNT_SID=
      - TWILIO_AUTH_TOKEN=
      - TWILIO_FROM_NUMBER=
      - TWILIO_TO_NUMBER=whatsapp:
    volumes:
      - consumer1_offsets:/app/offsets
    networks:
      - aklight_net
    depends_on:
      broker1:
        condition: service_healthy
      producer1:
        condition: service_started
    restart: unless-stopped

  # STRESS TEST
  stress1:
    build:
      context: .
      dockerfile: stress/Dockerfile
    container_name: aklight_stress1
    hostname: stress1
    environment:
      - STRESS_MODE=both
      - STRESS_DURATION=60
      - STRESS_INTENSITY=200
    networks:
      - aklight_net
    profiles:
      - stress
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

# VOLUMES
volumes:
  broker1_data:
  broker2_data:
  consumer1_offsets:

# NETWORKS
networks:
  aklight_net:
    driver: bridge
