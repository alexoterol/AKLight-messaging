services:
  # ==================== BROKERS ====================
  broker1:
    build: ./broker
    container_name: aklight_broker1
    ports:
      - "7000:7000"
    volumes:
      - broker1_data:/app/data
    networks:
      - aklight_network
    restart: unless-stopped

  broker2:
    build: ./broker
    container_name: aklight_broker2
    command: ["sh", "-c", "echo '=== BROKER STARTING ===' && echo 'ID: 2' && echo 'Port: 7001' && stdbuf -oL -eL ./broker 2 2>&1"]
    ports:
      - "7001:7001"
    volumes:
      - broker2_data:/app/data
    networks:
      - aklight_network
    restart: unless-stopped

  # ==================== PRODUCERS ====================
  # Producer1 -> Broker1 (7000)
  producer1:
    build: ./producer
    container_name: aklight_producer1
    command: ["sh", "-c", "echo '=== PRODUCER STARTING ===' && sleep 3 && echo 'Connecting to broker1:7000...' && stdbuf -oL -eL ./producer producer1 metrics/docker broker1 7000 2>&1"]
    depends_on:
      - broker1
    networks:
      - aklight_network
    restart: unless-stopped

  # Producer2 -> Broker2 (7001)
  producer2:
    build: ./producer
    container_name: aklight_producer2
    command: ["sh", "-c", "echo '=== PRODUCER STARTING ===' && sleep 3 && echo 'Connecting to broker2:7001...' && stdbuf -oL -eL ./producer producer2 metrics/docker broker2 7001 2>&1"]
    depends_on:
      - broker2
    networks:
      - aklight_network
    restart: unless-stopped

  # ==================== CONSUMERS ====================
  # Consumer1 -> Broker1: Solo CPU de producer1
  consumer1:
    build: ./consumer
    container_name: aklight_consumer1
    command: ["sh", "-c", "echo '=== CONSUMER STARTING ===' && sleep 5 && echo 'Connecting to broker1:7000...' && stdbuf -oL -eL ./consumer consumer1 1 broker1 7000 'metrics/docker/producer1/cpu' 2>&1"]
    depends_on:
      - broker1
      - producer1
    networks:
      - aklight_network
    restart: unless-stopped

  # Consumer2 -> Broker1: Todo de producer1 (wildcard)
  consumer2:
    build: ./consumer
    container_name: aklight_consumer2
    command: ["sh", "-c", "echo '=== CONSUMER STARTING ===' && sleep 5 && echo 'Connecting to broker1:7000...' && stdbuf -oL -eL ./consumer consumer2 1 broker1 7000 'metrics/docker/producer1/#' 2>&1"]
    depends_on:
      - broker1
      - producer1
    networks:
      - aklight_network
    restart: unless-stopped

  # Consumer3 -> Broker2: Solo CPU de producer2
  consumer3:
    build: ./consumer
    container_name: aklight_consumer3
    command: ["sh", "-c", "echo '=== CONSUMER STARTING ===' && sleep 5 && echo 'Connecting to broker2:7001...' && stdbuf -oL -eL ./consumer consumer3 0 broker2 7001 'metrics/docker/producer2/cpu' 2>&1"]
    depends_on:
      - broker2
      - producer2
    networks:
      - aklight_network
    restart: unless-stopped

  # Consumer4 -> Broker2: Todo de producer2 (wildcard)
  consumer4:
    build: ./consumer
    container_name: aklight_consumer4
    command: ["sh", "-c", "echo '=== CONSUMER STARTING ===' && sleep 5 && echo 'Connecting to broker2:7001...' && stdbuf -oL -eL ./consumer consumer4 1 broker2 7001 'metrics/docker/producer2/#' 2>&1"]
    depends_on:
      - broker2
      - producer2
    networks:
      - aklight_network
    restart: unless-stopped

volumes:
  broker1_data:
  broker2_data:

networks:
  aklight_network:
    driver: bridge